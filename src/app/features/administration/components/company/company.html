<div class="flex flex-col gap-6">
    @if (companyResource.isLoading() || saving()) {
    <!-- Skeleton: Datos de la Empresa -->
    <p-card>
        <div class="flex flex-col gap-4">
            <p-skeleton width="12rem" height="1.5rem" />
            <p-skeleton width="20rem" height="1rem" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
            </div>
        </div>
    </p-card>

    <!-- Skeleton: Suscripción -->
    <p-card>
        <div class="flex flex-col gap-4">
            <p-skeleton width="10rem" height="1.5rem" />
            <p-skeleton width="18rem" height="1rem" />
            <p-skeleton height="4rem" borderRadius="0.5rem" />
            <p-skeleton width="12rem" height="1.25rem" />
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <p-skeleton height="8rem" borderRadius="0.5rem" />
                <p-skeleton height="8rem" borderRadius="0.5rem" />
                <p-skeleton height="8rem" borderRadius="0.5rem" />
            </div>
            <p-skeleton width="14rem" height="1.25rem" />
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                <p-skeleton height="3.5rem" borderRadius="0.5rem" />
                <p-skeleton height="3.5rem" borderRadius="0.5rem" />
                <p-skeleton height="3.5rem" borderRadius="0.5rem" />
                <p-skeleton height="3.5rem" borderRadius="0.5rem" />
                <p-skeleton height="3.5rem" borderRadius="0.5rem" />
            </div>
        </div>
    </p-card>

    <!-- Skeleton: Usuarios -->
    <p-card>
        <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between">
                <p-skeleton width="12rem" height="1.5rem" />
                <p-skeleton width="10rem" height="2.5rem" borderRadius="0.5rem" />
            </div>
            <div class="flex flex-col gap-3">
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
                <p-skeleton height="2.5rem" />
            </div>
        </div>
    </p-card>
    } @else {
    <p-fluid>
        <p-card>
            <ng-template #title>
                <div class="flex items-center gap-2">
                    <i class="pi pi-building text-primary"></i>
                    <span>Datos de la Empresa</span>
                </div>
            </ng-template>
            <ng-template #subtitle>
                <span class="text-muted-color text-sm">Información general de tu empresa. Puedes actualizar el nombre, ciudad y sector.</span>
            </ng-template>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <div class="flex flex-col gap-1">
                    <p-floatlabel variant="on">
                        <input pInputText id="name" [formControl]="form.controls.name" [invalid]="isInvalid('name')" />
                        <label for="name">Nombre *</label>
                    </p-floatlabel>
                    @if (isInvalid('name')) {
                    <small class="text-red-500">{{ getErrorMessage('name') }}</small>
                    }
                </div>

                <div class="flex flex-col gap-1">
                    <p-floatlabel variant="on">
                        <input pInputText id="nit" [formControl]="form.controls.nit" />
                        <label for="nit">NIT</label>
                    </p-floatlabel>
                </div>

                <div class="flex flex-col gap-1">
                    <p-floatlabel variant="on">
                        <input pInputText id="city" [formControl]="form.controls.state" />
                        <label for="city">Departamento</label>
                    </p-floatlabel>
                </div>

                <div class="flex flex-col gap-1">
                    <p-floatlabel variant="on">
                        <input pInputText id="city" [formControl]="form.controls.city" />
                        <label for="city">Ciudad *</label>
                    </p-floatlabel>
                </div>

                <div class="flex flex-col gap-1">
                    <p-floatlabel variant="on">
                        <p-select id="sectorId" [options]="sectorsResource.value() ?? []" optionLabel="label" optionValue="id" [formControl]="form.controls.sectorId" [invalid]="isInvalid('sectorId')" />
                        <label for="sectorId">Sector *</label>
                    </p-floatlabel>
                    @if (isInvalid('sectorId')) {
                    <small class="text-red-500">{{ getErrorMessage('sectorId') }}</small>
                    }
                </div>

                <div class="flex flex-col gap-1">
                    <p-floatlabel variant="on">
                        <input pInputText id="createdAt" [formControl]="form.controls.createdAt" />
                        <label for="createdAt">Fecha de Creación</label>
                    </p-floatlabel>
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-muted-color text-sm">Estado:</span>
                    <p-tag [value]="form.controls.isActive.value ? 'Activo' : 'Inactivo'" [severity]="form.controls.isActive.value ? 'success' : 'danger'" />
                </div>
            </div>
        </p-card>
    </p-fluid>

    <div class="flex justify-end">
        <p-button label="Actualizar" icon="pi pi-check" severity="success" [loading]="saving()" (onClick)="onSave()" />
    </div>

    <!-- Sección de Suscripción -->
    @if (subscriptionUsage(); as data) {
    <p-card>
        <ng-template #title>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="pi pi-crown text-primary"></i>
                    <span>Suscripción</span>
                </div>
                <p-tag [value]="data.subscription.isActive ? 'Activa' : 'Inactiva'" [severity]="data.subscription.isActive ? 'success' : 'danger'" />
            </div>
        </ng-template>
        <ng-template #subtitle>
            <span class="text-muted-color text-sm">Detalles de tu plan actual y consumo de recursos.</span>
        </ng-template>

        <div class="flex flex-col gap-5">
            <!-- Plan info -->
            <div class="flex items-center justify-between bg-primary/5 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <i class="pi pi-star-fill text-primary text-2xl"></i>
                    <div>
                        <span class="text-muted-color text-sm">Plan actual</span>
                        <p class="text-xl font-semibold m-0">{{ data.subscription.name }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-muted-color text-sm">Precio</span>
                    <p class="text-xl font-semibold m-0">{{ data.subscription.price | number:'1.0-0' }} COP / {{ data.subscription.isMonthly ? 'mes' : 'año' }}</p>
                </div>
            </div>

            <!-- Consumo de recursos -->
            <div>
                <h3 class="text-lg font-semibold mb-3">Consumo de recursos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Usuarios -->
                    <div class="rounded-lg border border-surface p-4 flex flex-col gap-3">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-users text-primary"></i>
                            <span class="font-medium">Usuarios</span>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span class="text-2xl font-bold">{{ data.usage.users.used }}</span>
                            <span class="text-muted-color text-sm">de {{ data.usage.users.max }}</span>
                        </div>
                        <p-progressBar [value]="usagePercentage(data.usage.users.used, data.usage.users.max)" [showValue]="false" />
                        <span
                            class="text-sm"
                            [ngClass]="{
                            'text-green-500': usageSeverity(data.usage.users.used, data.usage.users.max) === 'success',
                            'text-yellow-500': usageSeverity(data.usage.users.used, data.usage.users.max) === 'warn',
                            'text-red-500': usageSeverity(data.usage.users.used, data.usage.users.max) === 'danger'
                        }"
                        >
                            {{ data.usage.users.remaining }} disponible{{ data.usage.users.remaining !== 1 ? 's' : '' }}
                        </span>
                    </div>

                    <!-- Clientes -->
                    <div class="rounded-lg border border-surface p-4 flex flex-col gap-3">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-address-book text-primary"></i>
                            <span class="font-medium">Clientes</span>
                        </div>
                        @if (data.usage.customers.unlimited) {
                        <div class="flex items-baseline justify-between">
                            <span class="text-2xl font-bold">{{ data.usage.customers.used }}</span>
                            <span class="text-muted-color text-sm">Ilimitados</span>
                        </div>
                        <p-progressBar [value]="100" [showValue]="false" [style]="{ height: '8px' }" color="var(--primary-color)" />
                        <span class="text-sm text-primary">Sin límite</span>
                        } @else {
                        <div class="flex items-baseline justify-between">
                            <span class="text-2xl font-bold">{{ data.usage.customers.used }}</span>
                            <span class="text-muted-color text-sm">de {{ data.usage.customers.max }}</span>
                        </div>
                        <p-progressBar [value]="usagePercentage(data.usage.customers.used, data.usage.customers.max)" [showValue]="false" />
                        <span
                            class="text-sm"
                            [ngClass]="{
                            'text-green-500': usageSeverity(data.usage.customers.used, data.usage.customers.max) === 'success',
                            'text-yellow-500': usageSeverity(data.usage.customers.used, data.usage.customers.max) === 'warn',
                            'text-red-500': usageSeverity(data.usage.customers.used, data.usage.customers.max) === 'danger'
                        }"
                        >
                            {{ data.usage.customers.remaining }} disponible{{ data.usage.customers.remaining !== 1 ? 's' : '' }}
                        </span>
                        }
                    </div>

                    <!-- Estudios este mes -->
                    <div class="rounded-lg border border-surface p-4 flex flex-col gap-3">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-file-check text-primary"></i>
                            <span class="font-medium">Estudios este mes</span>
                        </div>
                        @if (data.usage.studiesThisMonth.unlimited) {
                        <div class="flex items-baseline justify-between">
                            <span class="text-2xl font-bold">{{ data.usage.studiesThisMonth.used }}</span>
                            <span class="text-muted-color text-sm">Ilimitados</span>
                        </div>
                        <p-progressBar [value]="100" [showValue]="false" [style]="{ height: '8px' }" color="var(--primary-color)" />
                        <span class="text-sm text-primary">Sin límite</span>
                        } @else {
                        <div class="flex items-baseline justify-between">
                            <span class="text-2xl font-bold">{{ data.usage.studiesThisMonth.used }}</span>
                            <span class="text-muted-color text-sm">de {{ data.usage.studiesThisMonth.max }}</span>
                        </div>
                        <p-progressBar [value]="usagePercentage(data.usage.studiesThisMonth.used, data.usage.studiesThisMonth.max)" [showValue]="false" />
                        <span
                            class="text-sm"
                            [ngClass]="{
                            'text-green-500': usageSeverity(data.usage.studiesThisMonth.used, data.usage.studiesThisMonth.max) === 'success',
                            'text-yellow-500': usageSeverity(data.usage.studiesThisMonth.used, data.usage.studiesThisMonth.max) === 'warn',
                            'text-red-500': usageSeverity(data.usage.studiesThisMonth.used, data.usage.studiesThisMonth.max) === 'danger'
                        }"
                        >
                            {{ data.usage.studiesThisMonth.remaining }} disponible{{ data.usage.studiesThisMonth.remaining !== 1 ? 's' : '' }}
                        </span>
                        }
                    </div>
                </div>
            </div>

            <!-- Características del plan -->
            <div>
                <h3 class="text-lg font-semibold mb-3">Características del plan</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="flex items-center gap-3 rounded-lg border border-surface p-3">
                        <i class="pi pi-chart-bar text-lg" [ngClass]="data.features.dashboardLevel.label !== 'basic' ? 'text-green-500' : 'text-primary'"></i>
                        <div class="flex flex-col">
                            <span class="text-sm text-muted-color">Dashboard</span>
                            <span class="font-medium">{{ dashboardLevelLabel(data.features.dashboardLevel.label) }}</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 rounded-lg border border-surface p-3">
                        <i class="pi pi-headphones text-lg" [ngClass]="data.features.supportLevel.label !== 'email' ? 'text-green-500' : 'text-primary'"></i>
                        <div class="flex flex-col">
                            <span class="text-sm text-muted-color">Soporte</span>
                            <span class="font-medium">{{ supportLevelLabel(data.features.supportLevel.label) }}</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 rounded-lg border border-surface p-3" [pTooltip]="data.features.excelReports ? 'Incluido en tu plan' : 'No incluido en tu plan'" tooltipPosition="top">
                        <i class="pi text-lg" [ngClass]="data.features.excelReports ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-400'"></i>
                        <span class="font-medium">Reportes Excel</span>
                    </div>

                    <div class="flex items-center gap-3 rounded-lg border border-surface p-3" [pTooltip]="data.features.emailNotifications ? 'Incluido en tu plan' : 'No incluido en tu plan'" tooltipPosition="top">
                        <i class="pi text-lg" [ngClass]="data.features.emailNotifications ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-400'"></i>
                        <span class="font-medium">Notificaciones por correo</span>
                    </div>

                    <div class="flex items-center gap-3 rounded-lg border border-surface p-3" [pTooltip]="data.features.themeCustomization ? 'Incluido en tu plan' : 'No incluido en tu plan'" tooltipPosition="top">
                        <i class="pi text-lg" [ngClass]="data.features.themeCustomization ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-400'"></i>
                        <span class="font-medium">Personalización de tema</span>
                    </div>
                </div>
            </div>
        </div>
    </p-card>
    }

    <!-- Sección de Usuarios -->
    <ng-template #subtitle>
        <span class="text-muted-color text-sm">Usuarios con acceso a esta empresa. Puedes invitar nuevos o eliminar los existentes.</span>
    </ng-template>

    <app-custom-table [tableSettings]="usersTableSettings()" [data]="usersData()" [totalRecords]="usersData().length" (actionClick)="onUserAction($event)" (addClick)="onInviteUser()" />
    }
</div>
